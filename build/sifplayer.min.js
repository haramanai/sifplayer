/*
 Copyright (c) 2012 haramanai.
 sifPlayer
 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.
*/
this.sifPlayer=this.sifPlayer||{};
(function(){function f(a,b,c,g,e,d){d||(d="");this.sifPath=d;this.x=b;this.y=c;this.width=g;this.height=e;this.init(a)}var d=f.prototype;d.x=null;d.y=null;d.width=null;d.width=null;d.sifPath="";d.timeline=null;d.init=function(a){function b(a){function g(a,b){e[a]?(e[a].constructor!=Array&&(e[a]=[e[a]]),e[a][e[a].length]=b):e[a]=b}var e={},d,f,h;for(d=0;f=a.attributes[d];d++)g("_"+f.name,sifPlayer._toSifValue(f.value));for(d=0;f=a.childNodes[d];d++)if(1==f.nodeType)if(h=f.nodeName,1==f.childNodes.length&&
3==f.firstChild.nodeType)g(f.nodeName,sifPlayer._toSifValue(f.firstChild.nodeValue));else switch(h){case "param":e[f.getAttribute("name")]=b(f);break;case "layer":"undefined"==typeof e[h]&&(e[h]=[]);switch(f.getAttribute("type")){case "rotate":case "translate":case "zoom":g("layer",{_type:"restore"});e.layer.unshift(b(f));break;default:g(f.nodeName,b(f))}break;case "waypoint":"undefined"==typeof e[h]&&(e[h]=[]);default:g(h,b(f))}return e}a=b(a.getElementsByTagName("canvas")[0]);this.timeline=new createjs.Timeline;
this.timeline.setPaused(!0);this._getCanvasData(a);this.timeline.duration=this.sif.canvas.end_time;this.timeline.gotoAndPlay(this.sif.canvas.start_time)};d.draw=function(a){var b=this.sif.canvas,c=this.sif.canvas.layer;a.save();a.setTransform(this.width/(b.view_box[2]-b.view_box[0]),0,0,this.height/(b.view_box[3]-b.view_box[1]),this.x+this.width/2,this.y+this.height/2);for(b=0;b<c.length;b++)c[b].draw(a);a.restore();console.log(createjs.Ticker.getMeasuredFPS())};d._getCanvasData=function(a){this.sif=
{};this.sif.canvas={};this.sif.canvas.version=a._version;this.sif.canvas.width=a._width;this.sif.canvas.height=a._height;var b=a["_view-box"].split(" ");this.sif.canvas.view_box=[parseFloat(b[0]),parseFloat(b[1]),parseFloat(b[2]),parseFloat(b[3])];this.sif.canvas.antialias=a._antialias;this.sif.canvas.fps=a._fps;this.sif.canvas.begin_time=sifPlayer._canvasTimeToMillis(a["_begin-time"],this.sif.canvas.fps);this.sif.canvas.end_time=sifPlayer._canvasTimeToMillis(a["_end-time"],this.sif.canvas.fps);b=
a._bgcolor.split(" ");this.sif.canvas.bgcolor={};this.sif.canvas.bgcolor.r=Math.round(256*parseFloat(b[0]));this.sif.canvas.bgcolor.g=Math.round(256*parseFloat(b[1]));this.sif.canvas.bgcolor.b=Math.round(256*parseFloat(b[2]));this.sif.canvas.bgcolor.a=Math.round(256*parseFloat(b[3]));this.sif.canvas.name=a.name;this.sif.canvas.defs=this._getDefs(a.defs);this.sif.canvas.layer=[];for(b=0;b<a.layer.length;b++)this.sif.canvas.layer.push(sifPlayer._getLayer(this,a.layer[b]))};d._getDefs=function(a){var b=
{};for(name in a)if(a[name].constructor!=Array)"animated"===name?(b[a[name]._id]={},b[a[name]._id].animated=a[name]):(b[a._id]=a[name],b[a._id]._type=name);else for(var c=0;c<a[name].length;c++)"animated"===name?(b[a[name][c]._id]={},b[a[name][c]._id].animated=a[name][c]):(b[a[name][c]._id]={},b[a[name][c]._id][name]=a[name][c],b[a[name][c]._id]._type=name);return b};sifPlayer._secsToMillis=function(a){return 1E3*parseFloat(a.replace("s",""))};sifPlayer._canvasTimeToMillis=function(a,b){var c=0,g;
if(0<a.search("s"))if(g=a.split("s"),g.length)c+=1E3*parseFloat(g[0]),0<g[1].search("f")&&(c+=1E3*parseFloat(g[1].replace("f",""))/b);else return 1E3*parseFloat(g);else c+=1E3*parseFloat(a.replace("f",""))/b;return c};sifPlayer._getLayer=function(a,b){if(sifPlayer[b._type])return new sifPlayer[b._type](a,b);if("import"===b._type)return new sifPlayer.Import(a,b);console.log("EERRROOR  "+b._type+" layer it's not supported");var c=new sifPlayer.Layer;c.initLayer(a,b);return c};sifPlayer._toSifValue=
function(a){var b=Number(a);return!isNaN(b)?b:"true"===a?!0:"false"===a?!1:":"===a[0]?a.substr(1):a};sifPlayer.SifObject=f})();(function(){function f(){}var d=f.prototype;d.parent=null;d.sifobj=null;d.type=null;d.initLayer=function(a,b){a.hasOwnProperty("sifPath")?this.sifobj=a:(this.parent=a,this.sifobj=a.sifobj);this.type=b._type};d.draw=function(){};d._setParam=function(a,b,c){var g,e,d=this.sifobj;c||alert(this.type+"  "+a);e=this._getValueType(c);e||(alert("no param type"),alert(JSON.stringify(c)));switch(e){case "greyed":e=c.greyed._type;c=c.greyed;c[e]=c.link[e];delete c.link;break;case "radial_composite":b[a]={};
b[a]._type=e;b[a].radial_composite={};c[e]._radius&&(c[e].radius=this.sifobj.sif.canvas.defs[c[e]._radius]);c[e]._theta&&(c[e].theta=this.sifobj.sif.canvas.defs[c[e]._theta]);this._setParam("radius",b[a][e],c[e].radius);this._setParam("theta",b[a][e],c[e].theta);return;case "gradient":b.gradient={};b.gradient.color=[];a=0;for(e=c.gradient.color.length;a<e;a++)d={},g={},g.color=c.gradient.color[a],this._setParam("color",d,g),d.color.pos=g.color._pos,b.gradient.color.push(d.color);return}if(c._use)return this._setParam(a,
b,d.sif.canvas.defs[c._use]);g=c;b[a]={};var f={paused:!0,useTick:!0};switch(e){case "vector":if(g.animated){c=g.animated.waypoint;b[a].x=c[0][e].x;b[a].y=c[0][e].y;b=createjs.Tween.get(b[a],f);"0s"!==c[0]._time&&b.to({x:c[0][e].x,y:c[0][e].y},sifPlayer._secsToMillis(c[0]._time),createjs.Ease.linear);for(a=0;a<c.length-1;a++)b.to({x:c[a+1][e].x,y:c[a+1][e].y},sifPlayer._secsToMillis(c[a+1]._time)-sifPlayer._secsToMillis(c[a]._time),createjs.Ease.linear);d.timeline.addTween(b)}else g[e]||alert(JSON.stringify(g)),
g[e]||alert(JSON.stringify(c)),b[a].x=g[e].x,b[a].y=g[e].y;break;case "color":if(g.animated){c=g.animated.waypoint;b[a].r=c[0][e].r;b[a].g=c[0][e].g;b[a].b=c[0][e].b;b[a].a=c[0][e].a;b=createjs.Tween.get(b[a],f);"0s"!==c[0]._time&&b.to({r:c[0][e].r,g:c[0][e].g,b:c[0][e].b,a:c[0][e].a},sifPlayer._secsToMillis(c[0]._time),createjs.Ease.linear);for(a=0;a<c.length-1;a++)b.to({r:c[a+1][e].r,g:c[a+1][e].g,b:c[a+1][e].b,a:c[a+1][e].a},sifPlayer._secsToMillis(c[a+1]._time)-sifPlayer._secsToMillis(c[a]._time),
createjs.Ease.linear);d.timeline.addTween(b)}else b[a].r=g[e].r,b[a].g=g[e].g,b[a].b=g[e].b,b[a].a=g[e].a;break;default:if(g.animated){c=g.animated.waypoint;b[a].value=c[0][e]._value;b=createjs.Tween.get(b[a],f);"0s"!==c[0]._time&&b.to({value:c[0][e]._value},sifPlayer._secsToMillis(c[0]._time),createjs.Ease.linear);for(a=0;a<c.length-1;a++)b.to({value:c[a+1][e]._value},sifPlayer._secsToMillis(c[a+1]._time)-sifPlayer._secsToMillis(c[a]._time),createjs.Ease.linear);d.timeline.addTween(b)}else g[e]||
alert(JSON.stringify(g)+"param_type : "+e+" param_name : "+a+" layer type : "+this.type),b[a].value=g[e]._value}};d._getValueType=function(a){if(a._type)return a._type;if(a._use)return"use";if(a.animated)return a.animated._type;if(a.vector)return"vector";if(a.integer)return"integer";if(a.real)return"real";if(a.bool)return"bool";if(a.angle)return"angle";if(a.color)return"color";if(a.radial_composite)return"radial_composite";if(a.greyed)return"greyed";if(a.gradient)return"gradient"};d._getBlend=function(){switch(this.blend_method.value){case 0:return"source-over";
case 1:return"copy";case 13:return"source-atop";case 21:return"source-in";case 12:return"destination-over";case 19:return"destination-out";case 14:return"destination-in";default:return"source-over"}};d._getTotalAmount=function(){var a=this.amount.value,b=this.parent;return b?b._getTotalAmount()*a:a};sifPlayer.Layer=f})();(function(){function f(a,b){this.init(a,b)}var d=f.prototype=new sifPlayer.Layer;d.init=function(a,b){this.initLayer(a,b);this._setParam("amount",this,b.amount);this._setParam("blend_method",this,b.blend_method);this._setParam("origin",this,b.origin);this._setParam("zoom",this,b.zoom);this._setParam("focus",this,b.focus);this._getLayers(b.canvas.canvas.layer)};d._getLayers=function(a){this.layer=[];for(var b=0;b<a.length;b++)this.layer.push(sifPlayer._getLayer(this,a[b]))};d.draw=function(a){var b=
Math.exp(this.zoom.value),c=this.layer;a.save();a.translate(this.focus.x,this.focus.y);a.scale(b,b);a.translate(-this.focus.x,-this.focus.y);a.translate(this.origin.x/b,this.origin.y/b);for(var b=0,d=c.length;b<d;b++)c[b].draw(a);a.restore()};sifPlayer.PasteCanvas=f})();(function(){function f(a,b){this.init(a,b)}var d=f.prototype=new sifPlayer.Layer;d.init=function(a,b){this.initLayer(a,b);this._setParam("blend_method",this,b.blend_method);this._setParam("amount",this,b.amount);this._setParam("origin",this,b.origin);this._setParam("color",this,b.color);this._getBline(b.bline)};d.draw=function(a){var b,c;a.fillStyle="rgba("+Math.round(256*this.color.r)+", "+Math.round(256*this.color.g)+", "+Math.round(256*this.color.b)+", "+Math.round(256*this.color.a)+")";a.globalAlpha=
this._getTotalAmount();a.save();a.translate(this.origin.x,this.origin.y);a.globalCompositeOperation=this._getBlend();a.beginPath();b=this.bline.entry[0].point;a.moveTo(b.x,b.y);for(var d=0;d<this.bline.entry.length-1;d++)b=this.bline.entry[d],c=this.bline.entry[d+1],b.split.value?this._bezierPart(a,b.point,c.point,b.t2,c.t1):this._bezierPart(a,b.point,c.point,b.t1,c.t1);this.bline.loop&&(b=this.bline.entry[this.bline.entry.length-1],c=this.bline.entry[0],b.split.value?this._bezierPart(a,b.point,c.point,
b.t2,c.t1):this._bezierPart(a,b.point,c.point,b.t1,c.t1));a.closePath();a.fill();a.restore()};d._getBline=function(a){this.bline={};this.bline.entry=[];var b;this.bline.loop=a.bline._loop;for(var c=0;c<a.bline.entry.length;c++)b={},this.bline.entry.push(b),entry=this.bline.entry[c],entry.point={},entry.t1={},entry.t2={},a.bline.entry[c]._use&&(a.bline.entry[c]=this.sifobj.sif.canvas.defs[a.bline.entry[c]._use]),this._setParam("split",entry,a.bline.entry[c].composite.split),this._setParam("point",
entry,a.bline.entry[c].composite.point),a.bline.entry[c].composite.t1.scale?(this._setParam("theta",entry.t1,a.bline.entry[c].composite.t1.scale.link.radial_composite.theta),this._setParam("radius",entry.t1,a.bline.entry[c].composite.t1.scale.link.radial_composite.radius),this._setParam("scalar",entry.t1,a.bline.entry[c].composite.t1.scale.scalar)):(this._setParam("theta",entry.t1,a.bline.entry[c].composite.t1.radial_composite.theta),this._setParam("radius",entry.t1,a.bline.entry[c].composite.t1.radial_composite.radius)),
a.bline.entry[c].composite.t2.scale?(this._setParam("theta",entry.t2,a.bline.entry[c].composite.t2.scale.link.radial_composite.theta),this._setParam("radius",entry.t2,a.bline.entry[c].composite.t2.scale.link.radial_composite.radius),this._setParam("scalar",entry.t2,a.bline.entry[c].composite.t2.scale.scalar)):(this._setParam("theta",entry.t2,a.bline.entry[c].composite.t2.radial_composite.theta),this._setParam("radius",entry.t2,a.bline.entry[c].composite.t2.radial_composite.radius))};d._bezierPart=
function(a,b,c,d,e){var f,i;i=d.scalar?(d.theta.value-180)*Math.PI/180:d.theta.value*Math.PI/180;f=Math.cos(i)*d.radius.value/3+b.x;b=Math.sin(i)*d.radius.value/3+b.y;i=e.scalar?(e.theta.value-180)*Math.PI/180:e.theta.value*Math.PI/180;d=-(Math.cos(i)*e.radius.value)/3+c.x;e=-(Math.sin(i)*e.radius.value)/3+c.y;a.bezierCurveTo(f,b,d,e,c.x,c.y)};sifPlayer.region=f})();(function(){function f(a,b){this.init(a,b)}var d=f.prototype=new sifPlayer.Layer;d.init=function(a,b){this.initLayer(a,b);this._setParam("origin",this,b.origin);this.origin.radial_composite&&(this.draw=this.drawRadial)};d.draw=function(a){a.save();a.translate(this.origin.x,this.origin.y)};d.drawRadial=function(a){var b=this.origin.radial_composite.theta.value*Math.PI/180,c=Math.cos(b)*this.origin.radial_composite.radius.value,b=Math.sin(b)*this.origin.radial_composite.radius.value;a.save();a.translate(c,
b)};sifPlayer.translate=f})();(function(){function f(a,b){this.init(a,b)}var d=f.prototype=new sifPlayer.Layer;d.init=function(a,b){this.initLayer(a,b);this._setParam("origin",this,b.origin);this._setParam("amount",this,b.amount)};d.draw=function(a){a.save();a.translate(this.origin.x,this.origin.y);a.rotate(this.amount.value*Math.PI/180);a.translate(-this.origin.x,-this.origin.y)};sifPlayer.rotate=f})();(function(){function f(a,b){this.init(a,b)}var d=f.prototype=new sifPlayer.Layer;d.init=function(a,b){this.initLayer(a,b);this._setParam("center",this,b.center);this._setParam("amount",this,b.amount)};d.draw=function(a){var b=Math.exp(this.amount.value);a.save();a.translate(this.center.x,this.center.y);a.scale(b,b);a.translate(-this.center.x/b,-this.center.y/b)};sifPlayer.zoom=f})();(function(){function f(a,b){this.init(a,b)}var d=f.prototype=new sifPlayer.Layer;d.init=function(a,b){this.initLayer(a,b);this._setParam("tl",this,b.tl);this._setParam("br",this,b.br);this.image=new Image;this.image.src=this.sifobj.sifPath+b.filename.string};d.draw=function(a){a.save();this._drawImage();a.restore()};d._drawImage=function(){var a=this.sifobj.ctx,b=this.br.x-this.tl.x,c=this.tl.y-this.br.y,d,e;0>=b?(d=-1,b*=-1):d=1;0>=c?(e=1,c*=-1):e=-1;a.translate(this.tl.x,this.tl.y);a.scale(d,e);
a.drawImage(this.image,0,0,b,c)};sifPlayer.Import=f})();(function(){function f(a,b){this.init(a,b)}var d=f.prototype=new sifPlayer.Layer;d.init=function(a,b){this.initLayer(a,b)};d.draw=function(a){a.restore()};sifPlayer.restore=f})();(function(){function f(a,b){this.init(a,b)}var d=f.prototype=new sifPlayer.Layer;d.init=function(a,b){this.initLayer(a,b);this._setParam("amount",this,b.amount);this._setParam("origin",this,b.origin);this._setParam("radius",this,b.radius);this._setParam("color",this,b.color);this._setParam("blend_method",this,b.blend_method)};d.draw=function(a){var b=this.origin;a.fillStyle="rgba("+Math.round(256*this.color.r)+", "+Math.round(256*this.color.g)+", "+Math.round(256*this.color.b)+", "+Math.round(256*
this.color.a)+")";a.globalAlpha=this._getTotalAmount();a.globalCompositeOperation=this._getBlend();a.beginPath();a.arc(b.x,b.y,this.radius.value,0,2*Math.PI,!1);a.closePath();a.fill()};sifPlayer.circle=f})();(function(){function f(a,b){this.init(a,b)}var d=f.prototype=new sifPlayer.Layer;d.init=function(a,b){this.initLayer(a,b);this._setParam("amount",this,b.amount);this._setParam("blend_method",this,b.blend_method);this._setParam("p1",this,b.p1);this._setParam("p2",this,b.p2);this._setParam("gradient",this,b.gradient)};d.draw=function(a){for(var b=a.createLinearGradient(this.p1.x,this.p1.y,this.p2.x,this.p2.y),c=this.gradient.color,d=0,e=c.length;d<e;d++)b.addColorStop(c[d].pos,"rgba("+Math.round(256*
c[d].r)+", "+Math.round(256*c[d].g)+", "+Math.round(256*c[d].b)+", "+Math.round(256*c[d].a)+")");a.globalAlpha=this._getTotalAmount();a.globalCompositeOperation=this._getBlend();a.fillStyle=b;a.fillRect(-1E3,-1E3,2E3,2E3)};sifPlayer.linear_gradient=f})();(function(){function f(a,b){this.init(a,b)}var d=f.prototype=new sifPlayer.Layer;d.init=function(a,b){this.initLayer(a,b);this._setParam("amount",this,b.amount);this._setParam("blend_method",this,b.blend_method);this._setParam("center",this,b.center);this._setParam("radius",this,b.radius);this._setParam("gradient",this,b.gradient)};d.draw=function(a){for(var b=this.center.x,c=this.center.y,b=a.createRadialGradient(b,c,0,b,c,this.radius.value),c=this.gradient.color,d=0,e=c.length;d<e;d++)b.addColorStop(c[d].pos,
"rgba("+Math.round(256*c[d].r)+", "+Math.round(256*c[d].g)+", "+Math.round(256*c[d].b)+", "+Math.round(256*c[d].a)+")");a.globalAlpha=this._getTotalAmount();a.globalCompositeOperation=this._getBlend();a.fillStyle=b;a.fillRect(-1E3,-1E3,2E3,2E3)};sifPlayer.radial_gradient=f})();
